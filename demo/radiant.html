<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <title>D3-Celestial Starmap</title>
  <script type="text/javascript" src="../lib/d3.min.js"></script>
  <script type="text/javascript" src="../lib/d3.geo.projection.min.js"></script>
  <script type="text/javascript" src="../celestial.min.js"></script>
  <link rel="stylesheet" href="../celestial.css">
</head><body>
<div style="overflow:hidden;"><div id="celestial-map"></div></div>
<div id="celestial-form"></div>
<script type="text/javascript">
  function hour2degree(ra) {
    return ra > 12 ? (ra - 24) * 15 : ra * 15;
  }
  function hms2deg(hr, min, sec) {
    return hour2degree(hr + min / 60.0 + sec / 3600.0);
  }

  var config = {
    projection: "aitoff",
    geopos: [-77.849495, 166.728622], // McMurdo
    location: true,
    interactive: true,
    form: true,
    datapath: "../data/",
    stars: {proper: true},
    planets: {show: true},
    horizon: {show: true},
  };
  d3.text('../data/radnt_d.txt', raload);

  function raload(error, text) {
    if (error) {
      console.log("Unable to get radiant data: " + error);
      return;
    }

    var lines = text.split('\n')
    if (lines.length != 95) {
      console.log("Incorrect number of lines in radiant file");
      return;
    }
    if (lines.shift().trim() != "Radiant Densities") {
      console.log("Header incorrect");
      return;
    }
    var line = lines.shift().trim().split(" ");
    if (line[0] != "Rows") {
      console.log("Header (decl) incrrect");
      return;
    }
    var declstep = parseFloat(line[2]);

    var line = lines.shift().trim().split(" ");
    if (line[0] != "Right") {
      console.log("Header (ra) incorrect");
      return;
    }
    var rastep = parseFloat(line[4]);

    var line = lines.shift().trim().split(" ");
    if (line[0] != "First") {
      console.log("Header (first ra) incorrect");
      return;
    }
    var rastart = parseFloat(line[6]);

    var re = RegExp('\\d+', 'g');
    var raddata = [];
    for (var l = 0; l < lines.length - 1; l++) {
      raddata.push(lines[l].match(re).map(x => parseInt(x)));
    }

    var bins = [70, 140, 208, 277, 347, 415, 484, 554];
    function rgbas(r, g, b, a) {
      return "rgba(" + r + ", " + g + ", " + b + ", " + a + ")";
    }
    var alpha = 0.8;
    var colours = [rgbas(0, 191, 255, alpha), rgbas(0, 191, 255, alpha), rgbas(0, 255, 255, alpha), rgbas(144, 238, 144, alpha),
		   rgbas(144, 238, 144, alpha), rgbas(255, 255, 0, alpha), rgbas(255, 165, 0, alpha), rgbas(238, 130, 238, alpha)];

    var radiantFeatures = {
      "type":"FeatureCollection",
      "features":[],
    };

    for (var i = 0; i < 90; i++) {
      for (var j = 0; j < 90; j++) {
	var ra = j * rastep + hms2deg(rastart, 0, 0);
	var decl = 90 - (i * declstep);
	for (var b = bins.length - 1; b > 0; b--) {
	  if (raddata[i][j] >= bins[b]) {
	    break;
	  }
	}
	if (b == 0)
	  continue;
	var colour = colours[b];

	var feat = {
	  "type":"Feature",
	  "lineStyle": {
	    stroke:"#00",
	    width: .00001, // 0 width doesn't work..
	    fill: colour,
	  },
	  "textStyle": {
	    fill:"#f00",
	    font: "bold 15px Helvetica, Arial, sans-serif",
	    align: "center",
	    baseline: "middle"
	  },
	  "id":"radiant_" + i + "x" + j,
	  "properties": {
	    // Name
	    "n":"",
	  }, "geometry":{
	    // the line object as an array of point coordinates
	    "type":"MultiLineString",
	    "coordinates": [[
	      [ra - rastep / 2, decl - declstep / 2],
	      [ra + rastep / 2, decl - declstep / 2],
	      [ra + rastep / 2, decl + declstep / 2],
	      [ra - rastep / 2, decl + declstep / 2],
	      [ra - rastep / 2, decl - declstep / 2],
	    ]],
	  }
	};
	radiantFeatures.features.push(feat);
      }
    }

    Celestial.add({type:"line", callback: function(error, json) {
      // Load GeoJSON and convert coordinates
      var asterism = Celestial.getData(radiantFeatures, config.transform);

      // Add to celestiasl objects container in d3
      Celestial.container.selectAll(".asterisms")
	.data(asterism.features)
	.enter().append("path")
	.attr("class", "ast");
      // Trigger redraw to display changes
      Celestial.redraw();
    }, redraw: function() {
      // Select the added objects by class name as given previously
      Celestial.container.selectAll(".ast").each(function(d) {
	// Set line styles
	Celestial.setStyle(d.lineStyle);
	// Project objects on map
	Celestial.map(d);
	// draw on canvas
	Celestial.context.fill();
	Celestial.context.stroke();

      });
    }});
    Celestial.display(config);
    Celestial.date(new Date(2018, 4, 5)); // 5th May 2018
    Celestial.rotate({center: [0, -90, 0]});
  }
</script>
<footer id="d3-celestial-footer">
<p><a href="https://github.com/ofrohn/d3-celestial"><b>D3-Celestial</b></a> released under <a href="http://opensource.org/licenses/BSD-3-Clause">BSD license</a>. Copyright 2015-16 <a href="http://armchairastronautics.blogspot.com/" rel="author">Olaf Frohn</a>.
</p></footer>
  </body>
</html>
